open import Level using (_âŠ”_) renaming (zero to lzero; suc to lsuc)
open import Data.Nat using (â„•; zero; suc; pred; zâ‰¤n; sâ‰¤s; _â‰Ÿ_; _<_; _â‰¤_; _âˆ¸_; _+_)
open import Data.Nat.Properties using (nâ‰¤1+n; â‰¤-trans)
open import Data.Fin using (Fin)
open import Data.Fin.Subset using (Subset; _âˆˆ_; _âˆ‰_; _âŠ†_)
open import Data.Product using (âˆƒ; _Ã—_)
open import Relation.Binary using (_Preserves_âŸ¶_)
open import Relation.Binary.PropositionalEquality using (_â‰¡_; _â‰¢_)

module RoutingLib.Asynchronous.Schedule where

--------------------------------------------------------------------------------
-- Time --
--------------------------------------------------------------------------------
-- Some type definitions

-- Time
ð•‹ : Set
ð•‹ = â„•

-- Epoch numbers
Epoch : Set
Epoch = â„•

--------------------------------------------------------------------------------
-- Schedule --
--------------------------------------------------------------------------------
-- An asynchronous schedule for n processors

record Schedule (n : â„•) : Set where
  field
    -- "Î· t" is the current epoch at time t
    Î· : (t : ð•‹) â†’ Epoch
    -- "Ï€ e" is the set of participating nodes in epoch e
    Ï€ : Epoch â†’ Subset n
    -- "Î± t" is the subset of nodes that are active at time t
    Î± : (t : ð•‹) â†’ Subset n
    -- "Î² t i j" is the time at which the data used by node i at time t was generated by node j
    Î² : (t : ð•‹) (i j : Fin n) â†’ ð•‹

    -- Old axioms
    -- A1: Information can only be used after it is generated
    Î²-causality   : âˆ€ t i j â†’ Î² (suc t) i j â‰¤ t
    -- A2: Each element will eventually not need its value at time t
    Î²-finite      : âˆ€ t i j â†’ âˆƒ Î» k â†’ âˆ€ l â†’ Î² (k + l) i j â‰¢ t

    -- New axioms
    -- B1: Epochs increase monotonically
    Î·-mono         : Î· Preserves _â‰¤_ âŸ¶ _â‰¤_
    -- B2: Only participants may be active
    Î±-participants : âˆ€ t â†’ Î± t âŠ† Ï€ (Î· t)
    -- B3: If node is an ongoing participant then it must eventually activate
    Î±-activity    : âˆ€ i â†’ (âˆ€ e â†’ âˆƒ Î» k â†’ i âˆˆ Ï€ (e + k)) â†’ (âˆ€ t â†’ âˆƒ Î» k â†’ i âˆˆ Î± (t + k))

  -- "Ï t" is the set of participants at time t 
  Ï : ð•‹ â†’ Subset n
  Ï t = Ï€ (Î· t)

  -- Some derived properties
  Î²-decreasing : âˆ€ {t} i j â†’ 1 â‰¤ t â†’ Î² t i j â‰¤ t
  Î²-decreasing i j (sâ‰¤s zâ‰¤n) = â‰¤-trans (Î²-causality _ i j) (nâ‰¤1+n _)

--------------------------------------------------------------------------------
-- Pseudoperiods --
--------------------------------------------------------------------------------
-- A time period that "emulates" one synchronous iteration. During a
-- pseudoperiod every node activates and then we wait until all data before
-- those activation points are flushed from the system.

module _ {n} (ð“¢ : Schedule n) (e : Epoch) where

  record IsPseudoperiod (start end : ð•‹) : Setâ‚ where
    open Schedule ð“¢

    field
      mid       : ð•‹
      startâ‰¤mid : start < mid
      midâ‰¤end   : mid â‰¤ end
      Î·â‚›â‰¡e      : Î· start â‰¡ e
      Î·â‚‘â‰¡e      : Î· end   â‰¡ e
      phase1    : âˆ€ {i} â†’ i âˆˆ Ï e â†’ âˆƒ Î» t â†’ start â‰¤ t Ã— t â‰¤ mid Ã— i âˆˆ Î± t
      phase2    : âˆ€ i j {t} â†’ end â‰¤ t â†’ mid < Î² t i j
      
  data IsPseudoperiods : â„• â†’ ð•‹ â†’ ð•‹ â†’ Setâ‚ where
    none : âˆ€ {s e}     â†’ IsPseudoperiods 0 s e
    next : âˆ€ {s m e k} â†’ IsPseudoperiods k s m â†’ IsPseudoperiod m e â†’ IsPseudoperiods (suc k) s e

  record Pseudoperiods (k : â„•) : Setâ‚ where
    field
      start           : ð•‹
      end             : ð•‹
      kPseudoperiodic : IsPseudoperiods k start end
{-

--------------------------------------------------------------------------------
-- Pseudoperiodic schedule --
--------------------------------------------------------------------------------

record IsPseudoperiodic {n} (ð“¢ : Schedule n) : Set where
  open Schedule ð“¢
  field
    Ï† : â„• â†’ ð•‹
    Ï„ : â„• â†’ Fin n â†’ ð•‹

    -- Properties of Ï†
    Ï†-increasing : âˆ€ K â†’ K â‰¤ Ï† K

    -- Properties of Ï„
    Ï„-expired        : âˆ€ K t i j â†’ Ï„ K j â‰¤ Î² (Ï† (suc K) + t) i j
    Ï„-after-Ï†        : âˆ€ K i â†’ Ï† K â‰¤ Ï„ K i
    Ï„-active         : âˆ€ K i â†’ i âˆˆ Î± (Ï„ K i)
-}

{-
record PseudoperiodicSchedule (n : â„•) : Set where

  field
    ð“¢ : Schedule n
    isPseudoperiodic : IsPseudoperiodic ð“¢

  open Schedule ð“¢ public
  open IsPseudoperiodic isPseudoperiodic public
-}
